#!/bin/bash

# update perms on the settings file
chmod -R a+rwx docroot/sites/default/settings.php

# Check to see if the devify_config exists
ls -lR config | grep "devify_config" > /dev/null
# Save the exit code to a variable
FOUND_DEVIFY_CONFIG_FILE=$?

# If Exit code is 1, config was not found
if [ $FOUND_DEVIFY_CONFIG_FILE -eq 1 ]; then
  # Add prompt for the profile name, so the site can be installed
  read -p "What is the name of the profile for the site? " profile_name

  # Add prompt for the client name
  read -p "What is the client's name? " client_name

  # Rename generic profile
  find docroot/profiles/ -name "*sb_client*" -type f | grep -v devify | xargs sed -i '' -e "s/sb_client/$profile_name/g"
  find docroot/profiles/ -name "*sb_client*" -type d | while read directory; do mv "$directory" "${directory/sb_client/$profile_name}"; done
  find docroot/profiles/ -name "*sb_client*" -type f | while read filename; do mv "$filename" "${filename/sb_client/$profile_name}"; done

  # Rename client
  grep -rl 'SB_CLIENT' docroot/ | grep -v devify | xargs sed -i '' -e "s/SB_CLIENT/$client_name/g"
  
  # Add prompt for email addy
  read -p "What is your email address? " email_addy
  grep -rl 'EMAIL_ADDY' docroot/ | grep -v devify | xargs sed -i '' -e "s/EMAIL_ADDY/$email_addy/g"
  
  # Rename theme template with the new name
  theme_extension="_theme"
  theme_name=$profile_name$theme_extension
  grep -rl sb_template docroot/sites/ | grep -v devify | xargs sed -i '' -e "s/sb_template/$theme_name/g"
  find docroot/sites/all/ -name "*sb_template*" -type d | while read theme_directory; do mv "$theme_directory" "${theme_directory/sb_template/$theme_name}"; done
  find docroot/sites/all/ -name "*sb_template*" -type f | while read theme_filename; do mv "$theme_filename" "${theme_filename/sb_template/$theme_name}"; done  

  # Create a devify_config file
  echo -e "profile_name=$profile_name" >> config/devify_config
  echo -e 'client_name="$client_name"' >> config/devify_config
  
  # Get the browser and dev site url
  read -p "Do you use firefox or Google chrome (optional, opens the site in the browser after creation)? " browser
  if [ "$browser" ]; then
    read -p "What is the dev site url for this project? " site_url
    login_page="/user/login"
    start_page="$site_url$login_page"
    echo -e "start_page=$start_page" >> config/devify_config
    echo -e "browser=$browser" >> config/devify_config
  fi
  
else
  # Config was found, so source it for bash to use the vars to create the site
  . config/devify_config
fi

# move into the docroot for drush command execution
cd docroot

# install the site
drush -y -l default site-install $profile_name --site-name="$client_name" --clean-url=1 --account-pass=testing

# enable the dev module
drush -y -l default en sb_dev

# move back up to the root
cd ../

# open the site if the browser has been set
if [ ! "$browser" ]; then
  /usr/bin/open -a "/Applications/$browser.app" "http://$start_page"
fi

